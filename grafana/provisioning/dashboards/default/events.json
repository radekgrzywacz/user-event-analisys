{
  "id": null,
  "uid": "analysis-dashboard",
  "title": "User Event Analysis",
  "tags": ["analysis", "anomalies"],
  "timezone": "browser",
  "schemaVersion": 40,
  "version": 1,
  "refresh": "10s",
  "editable": true,
  "panels": [
    {
      "type": "stat",
      "title": "Aggregated Stats Overview",
      "gridPos": { "h": 5, "w": 8, "x": 0, "y": 0 },
      "targets": [
        {
          "refId": "A",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT COUNT(*) AS total_results FROM aggregated_results;"
        },
        {
          "refId": "B",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT COUNT(*) AS ml_anomalies FROM aggregated_results WHERE ml_anomaly = TRUE;"
        },
        {
          "refId": "C",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT COUNT(*) AS stat_anomalies FROM aggregated_results WHERE stat_anomaly = TRUE;"
        }
      ]
    },

    {
      "type": "timeseries",
      "title": "Anomalies Over Time (ML & Statistical)",
      "gridPos": { "h": 8, "w": 16, "x": 8, "y": 0 },
      "targets": [
        {
          "refId": "A",
          "rawQuery": true,
          "format": "time_series",
          "rawSql": "SELECT date_bin('1 minute', created_at, '1970-01-01') AS time, COUNT(*) AS anomalies FROM aggregated_results WHERE ml_anomaly OR stat_anomaly GROUP BY 1 ORDER BY 1;"
        },
        {
          "refId": "B",
          "rawQuery": true,
          "format": "time_series",
          "rawSql": "SELECT date_bin('1 minute', created_at, '1970-01-01') AS time, COUNT(*) AS ml_only FROM aggregated_results WHERE ml_anomaly GROUP BY 1 ORDER BY 1;"
        },
        {
          "refId": "C",
          "rawQuery": true,
          "format": "time_series",
          "rawSql": "SELECT date_bin('1 minute', created_at, '1970-01-01') AS time, COUNT(*) AS stat_only FROM aggregated_results WHERE stat_anomaly GROUP BY 1 ORDER BY 1;"
        }
      ]
    },

    {
      "type": "table",
      "title": "Recent Anomalies (from aggregated_results)",
      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 8 },
      "targets": [
        {
          "refId": "A",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT session_id, user_id, anomaly_type, ml_anomaly, stat_anomaly, event_count, unique_events, created_at AS timestamp FROM aggregated_results WHERE ml_anomaly OR stat_anomaly ORDER BY created_at DESC LIMIT 200;"
        }
      ],
      "options": {
        "showHeader": true
      }
    },

    {
      "type": "timeseries",
      "title": "Raw ML Anomalies Over Time (ml_results)",
      "gridPos": { "h": 7, "w": 12, "x": 0, "y": 18 },
      "targets": [
        {
          "refId": "A",
          "rawQuery": true,
          "format": "time_series",
          "rawSql": "SELECT date_bin('1 minute', timestamp, '1970-01-01') AS time, COUNT(*) AS ml_events FROM ml_results WHERE anomaly = TRUE GROUP BY 1 ORDER BY 1;"
        }
      ]
    },

    {
      "type": "timeseries",
      "title": "Raw Statistical Anomalies Over Time (stat_results)",
      "gridPos": { "h": 7, "w": 12, "x": 12, "y": 18 },
      "targets": [
        {
          "refId": "A",
          "rawQuery": true,
          "format": "time_series",
          "rawSql": "SELECT date_bin('1 minute', timestamp, '1970-01-01') AS time, COUNT(*) AS stat_events FROM stat_results WHERE anomaly = TRUE GROUP BY 1 ORDER BY 1;"
        }
      ]
    },

    {
      "type": "barchart",
      "title": "Anomalies by Type (aggregated_results)",
      "gridPos": { "h": 7, "w": 12, "x": 0, "y": 25 },
      "targets": [
        {
          "refId": "A",
          "rawQuery": true,
          "format": "table",
          "rawSql": "SELECT anomaly_type AS type, COUNT(*) AS count FROM aggregated_results WHERE anomaly_type IS NOT NULL AND anomaly_type <> '' GROUP BY anomaly_type ORDER BY count DESC LIMIT 20;"
        }
      ]
    },

    {
      "type": "table",
      "title": "Raw ML Results (last 200)",
      "gridPos": { "h": 7, "w": 12, "x": 12, "y": 25 },
      "targets": [
        {
          "refId": "A",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT session_id, user_id, anomaly, score, threshold, event_count, unique_events, timestamp FROM ml_results ORDER BY timestamp DESC LIMIT 200;"
        }
      ]
    },
    {
      "id": 100,
      "title": "Events vs Anomalies Over Time",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 32 },
      "targets": [
        {
          "refId": "A",
          "format": "time_series",
          "rawQuery": true,
          "rawSql": "SELECT date_bin('1 minute', timestamp, '1970-01-01') AS time, COUNT(*) AS events FROM raw_events WHERE $__timeFilter(timestamp) GROUP BY 1 ORDER BY 1;"
        },
        {
          "refId": "B",
          "format": "time_series",
          "rawQuery": true,
          "rawSql": "SELECT date_bin('1 minute', created_at, '1970-01-01') AS time, COUNT(*) AS anomalies FROM aggregated_results WHERE $__timeFilter(created_at) AND (ml_anomaly OR stat_anomaly) GROUP BY 1 ORDER BY 1;"
        }
      ],
      "options": {
        "legend": { "showLegend": true, "placement": "bottom" },
        "tooltip": { "mode": "multi" }
      }
    },
    {
      "id": 102,
      "title": "User Activity Breakdown Over Time",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 48 },
      "targets": [
        {
          "refId": "A",
          "format": "time_series",
          "rawQuery": true,
          "rawSql": "SELECT date_bin('1 minute', timestamp, '1970-01-01') AS time, COUNT(*) AS total FROM raw_events WHERE $__timeFilter(timestamp) GROUP BY 1 ORDER BY 1;"
        },
        {
          "refId": "B",
          "format": "time_series",
          "rawQuery": true,
          "rawSql": "SELECT date_bin('1 minute', timestamp, '1970-01-01') AS time, COUNT(*) FILTER (WHERE event_type='login') AS login FROM raw_events WHERE $__timeFilter(timestamp) GROUP BY 1 ORDER BY 1;"
        },
        {
          "refId": "C",
          "format": "time_series",
          "rawQuery": true,
          "rawSql": "SELECT date_bin('1 minute', timestamp, '1970-01-01') AS time, COUNT(*) FILTER (WHERE event_type='payment') AS payment FROM raw_events WHERE $__timeFilter(timestamp) GROUP BY 1 ORDER BY 1;"
        },
        {
          "refId": "D",
          "format": "time_series",
          "rawQuery": true,
          "rawSql": "SELECT date_bin('1 minute', timestamp, '1970-01-01') AS time, COUNT(*) FILTER (WHERE event_type='failed_login') AS failed_login FROM raw_events WHERE $__timeFilter(timestamp) GROUP BY 1 ORDER BY 1;"
        }
      ],
      "options": {
        "legend": { "placement": "bottom", "showLegend": true },
        "tooltip": { "mode": "multi" }
      }
    },
    {
      "id": 103,
      "title": "Event Types Distribution",
      "type": "barchart",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 56 },
      "targets": [
        {
          "refId": "A",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT event_type AS type, COUNT(*) AS count FROM raw_events GROUP BY event_type ORDER BY count DESC;"
        }
      ]
    },
    {
      "id": 104,
      "title": "Top 50 Users By Number of Events",
      "type": "table",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 56 },
      "targets": [
        {
          "refId": "A",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT user_id, COUNT(*) AS events FROM raw_events GROUP BY user_id ORDER BY events DESC LIMIT 50;"
        }
      ]
    }                
  ]
}
 